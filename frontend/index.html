<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <meta name="theme-color" content="#00C897">
    <title>Tattvam - Know Your Food</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="logo.png">
    <link rel="icon" type="image/png" sizes="512x512" href="logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 
                        primary: '#00C897', 
                        primaryDark: '#019A75', 
                        dark: '#0f172a', 
                        light: '#F8FAFC',
                        tattvamGreen: '#008f5d'
                    },
                    boxShadow: { 
                        card: '0 10px 30px -5px rgba(0, 0, 0, 0.05)', 
                        glass: '0 8px 32px 0 rgba(31, 38, 135, 0.15)'
                    },
                    animation: { 'spin-slow': 'spin 3s linear infinite', 'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>

    <style>
        body { 
            overscroll-behavior-y: none; 
            -webkit-tap-highlight-color: transparent;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .page-hidden { display: none !important; }

        /* Glass Header */
        .glass-header {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .dark .glass-header {
            background: rgba(15, 23, 42, 0.92);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Glass Cards */
        .glass-effect { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px); 
            border: 1px solid rgba(255, 255, 255, 0.5); 
        }
        .dark .glass-effect { 
            background: rgba(15, 23, 42, 0.85); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
        }

        /* Scanner */
        .scanner-laser {
            position: absolute; top: 0; left: 0; width: 100%; height: 3px;
            background: linear-gradient(to right, transparent, #00C897, transparent);
            box-shadow: 0 0 15px #00C897;
            animation: scan-move 2s linear infinite;
            z-index: 20; display: none;
        }
        @keyframes scan-move { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        /* Loader */
        .loading-overlay {
            position: fixed; inset: 0; z-index: 999;
            background: rgba(255, 255, 255, 0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .dark .loading-overlay { background: rgba(15, 23, 42, 0.95); }
        .loading-overlay.active { opacity: 1; pointer-events: all; }
        
        .loader-spinner {
            width: 50px; height: 50px;
            border: 4px solid #e2e8f0; border-top: 4px solid #00C897;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        .dark .loader-spinner { border-color: #334155; border-top-color: #00C897; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Install Banner */
        #install-banner { display: none; }
        #install-banner.show { display: flex; }

        /* Video Fix */
        #scanner-viewport video { width: 100% !important; height: 100% !important; object-fit: cover; border-radius: 1.5rem; }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        .fa-star, .fa-star-half-alt { color: #fbbf24; }
        .far.fa-star { color: #cbd5e1; }
    </style>
</head>
<body class="font-sans bg-gray-50 dark:bg-gray-950 text-gray-800 dark:text-gray-100 min-h-[100dvh] flex flex-col">

    <div id="loading-overlay" class="loading-overlay">
        <div class="loader-spinner mb-4"></div>
        <div class="text-primary font-bold tracking-widest text-sm animate-pulse">ANALYZING PURITY...</div>
    </div>

    <div id="install-banner" class="fixed bottom-24 left-4 right-4 z-50 bg-gray-900 text-white p-4 rounded-2xl shadow-2xl items-center justify-between animate-bounce">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center">
                <i class="fas fa-arrow-down text-white"></i>
            </div>
            <div>
                <h4 class="font-bold text-sm">Install Tattvam</h4>
                <p class="text-xs text-gray-400">Add to Home Screen</p>
            </div>
        </div>
        <button id="install-btn-banner" class="bg-primary hover:bg-primaryDark px-4 py-2 rounded-lg text-xs font-bold transition">Install</button>
        <button onclick="document.getElementById('install-banner').classList.remove('show')" class="absolute -top-2 -right-2 bg-gray-600 rounded-full w-6 h-6 flex items-center justify-center text-xs border border-white">&times;</button>
    </div>

    <div class="w-full md:max-w-md md:mx-auto bg-gray-50 dark:bg-gray-950 shadow-2xl min-h-[100dvh] flex flex-col relative">
        
        <header class="glass-header sticky top-0 z-40 px-5 py-4 pt-safe transition-all duration-300">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <button id="back-button" class="hidden w-10 h-10 rounded-full active:scale-95 transition flex items-center justify-center bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i class="fas fa-arrow-left text-lg"></i>
                    </button>
                    
                    <div id="header-logo" class="flex items-center gap-3">
                        <div class="relative w-11 h-11 flex items-center justify-center bg-gradient-to-br from-[#00C897] to-[#008f5d] rounded-2xl shadow-lg shadow-emerald-500/20 group">
                            <i class="fas fa-search text-white text-lg relative z-10 transform -translate-x-[1px]"></i>
                            <i class="fas fa-leaf text-white text-[10px] absolute top-2.5 right-2.5 z-20 opacity-90 transform rotate-12"></i>
                        </div>
                        <div class="flex flex-col justify-center">
                            <h1 class="text-2xl font-black tracking-tight text-tattvamGreen dark:text-primary leading-none">Tattvam</h1>
                            <span class="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-[0.25em] leading-tight pt-1">Pure Food</span>
                        </div>
                    </div>
                    <h2 id="header-title" class="text-xl font-bold hidden truncate text-gray-800 dark:text-white"></h2>
                </div>
                <div class="flex items-center gap-2">
                    <button id="dark-mode-toggle" class="w-10 h-10 rounded-full flex items-center justify-center text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 transition active:scale-90">
                        <i class="fas fa-moon text-lg"></i>
                    </button>
                    <button id="settings-button-header" class="w-10 h-10 rounded-full flex items-center justify-center text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 transition active:scale-90">
                        <i class="fas fa-cog text-lg"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto pb-28 px-5 pt-6 scroll-smooth" id="main-content-area">
            <section id="scanner-section" class="w-full"></section>
            <section id="product-section" class="w-full page-hidden"></section>
            <section id="explore-section" class="w-full page-hidden"></section>
            <section id="history-section" class="w-full page-hidden"></section>
            <section id="progress-section" class="w-full page-hidden"></section>
            <section id="settings-section" class="w-full page-hidden"></section>
        </main>

        <nav class="glass-effect fixed bottom-6 left-5 right-5 md:left-1/2 md:-translate-x-1/2 md:w-[400px] rounded-3xl shadow-glass z-50 pb-safe border border-white/50 dark:border-gray-700/50 backdrop-blur-xl">
            <div class="flex justify-around items-center p-2.5">
                <button class="nav-item flex-1 flex flex-col items-center py-2 rounded-2xl active:scale-95 transition duration-200 group" data-target="scanner-section">
                    <div class="w-10 h-6 mb-1 rounded-full flex items-center justify-center group-[.nav-active]:bg-primary/10 transition-colors">
                        <i class="fas fa-qrcode text-lg text-gray-400 group-[.nav-active]:text-primary transition-colors"></i>
                    </div>
                    <span class="text-[10px] font-bold text-gray-400 group-[.nav-active]:text-primary transition-colors">Scan</span>
                </button>
                <button class="nav-item flex-1 flex flex-col items-center py-2 rounded-2xl active:scale-95 transition duration-200 group" data-target="history-section">
                    <div class="w-10 h-6 mb-1 rounded-full flex items-center justify-center group-[.nav-active]:bg-blue-500/10 transition-colors">
                        <i class="fas fa-history text-lg text-gray-400 group-[.nav-active]:text-blue-500 transition-colors"></i>
                    </div>
                    <span class="text-[10px] font-bold text-gray-400 group-[.nav-active]:text-blue-500 transition-colors">History</span>
                </button>
                <button class="nav-item flex-1 flex flex-col items-center py-2 rounded-2xl active:scale-95 transition duration-200 group" data-target="explore-section">
                    <div class="w-10 h-6 mb-1 rounded-full flex items-center justify-center group-[.nav-active]:bg-orange-500/10 transition-colors">
                        <i class="fas fa-compass text-lg text-gray-400 group-[.nav-active]:text-orange-500 transition-colors"></i>
                    </div>
                    <span class="text-[10px] font-bold text-gray-400 group-[.nav-active]:text-orange-500 transition-colors">Explore</span>
                </button>
                <button class="nav-item flex-1 flex flex-col items-center py-2 rounded-2xl active:scale-95 transition duration-200 group" data-target="progress-section">
                    <div class="w-10 h-6 mb-1 rounded-full flex items-center justify-center group-[.nav-active]:bg-purple-500/10 transition-colors">
                        <i class="fas fa-chart-line text-lg text-gray-400 group-[.nav-active]:text-purple-500 transition-colors"></i>
                    </div>
                    <span class="text-[10px] font-bold text-gray-400 group-[.nav-active]:text-purple-500 transition-colors">Progress</span>
                </button>
            </div>
        </nav>
    </div>

    <div id="modal-container" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/60 p-4 backdrop-blur-sm transition-opacity"></div>
    <div id="toast-container" class="fixed top-24 left-1/2 -translate-x-1/2 z-[110] space-y-2 w-full max-w-xs pointer-events-none"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'https://tattvam-app.onrender.com';
            let html5QrCode;
            let currentBarcode = null;
            let scannerStartPromise = null;
            let currentSection = 'scanner-section';
            
            // PWA Install Logic
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('service-worker.js')
                        .then(reg => console.log('Service Worker Registered'))
                        .catch(err => console.log('Service Worker Failed', err));
                });
            }

            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                const banner = document.getElementById('install-banner');
                if(banner) banner.classList.add('show');
            });

            document.getElementById('install-btn-banner')?.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    document.getElementById('install-banner').classList.remove('show');
                }
            });

            window.installApp = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt = null;
                } else {
                    showToast('App is installed or not supported.', 'info');
                }
            };

            const sections = document.querySelectorAll('main > section');
            const navItems = document.querySelectorAll('.nav-item');
            const modalContainer = document.getElementById('modal-container');
            const backButton = document.getElementById('back-button');
            const headerLogo = document.getElementById('header-logo');
            const headerTitle = document.getElementById('header-title');
            const loadingOverlay = document.getElementById('loading-overlay');
            const mainContentArea = document.getElementById('main-content-area'); // New reference for scrolling

            function initializeApp() {
                setupEventListeners();
                initializeTheme();
                history.replaceState({ section: 'scanner-section' }, '', '');
                renderPage('scanner-section');
                window.addEventListener('popstate', (event) => {
                    if (event.state && event.state.section) renderPage(event.state.section, false);
                    else renderPage('scanner-section', false);
                });
            }

            function navigateTo(targetId) {
                if (currentSection === targetId) return;
                history.pushState({ section: targetId }, '', '');
                renderPage(targetId);
            }

            function renderPage(targetId) {
                currentSection = targetId;
                if (targetId !== 'scanner-section' && html5QrCode?.isScanning) stopScanner();

                sections.forEach(s => s.classList.add('page-hidden'));
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.classList.remove('page-hidden');
                    targetSection.classList.add('fade-in');
                    
                    // === BUG FIX: FORCE SCROLL TO TOP ===
                    if(mainContentArea) mainContentArea.scrollTop = 0;
                    window.scrollTo(0, 0);
                }

                navItems.forEach(n => {
                    const isTarget = n.dataset.target === targetId;
                    n.classList.toggle('nav-active', isTarget);
                });

                const pageTitles = {
                    'settings-section': 'Settings', 'history-section': 'History',
                    'explore-section': 'Explore', 'progress-section': 'Progress', 'product-section': 'Details'
                };
                
                if (targetId === 'scanner-section') {
                    headerLogo.classList.remove('hidden');
                    headerTitle.classList.add('hidden');
                    backButton.classList.add('hidden');
                } else {
                    headerLogo.classList.add('hidden');
                    headerTitle.textContent = pageTitles[targetId] || 'Tattvam';
                    headerTitle.classList.remove('hidden');
                    backButton.classList.remove('hidden');
                }

                const renderMap = {
                    'scanner-section': renderScanner, 'history-section': renderHistory,
                    'explore-section': renderExplore, 'settings-section': renderSettings,
                    'progress-section': renderProgress,
                };
                renderMap[targetId]?.();
            }

            function setupEventListeners() {
                navItems.forEach(item => item.addEventListener('click', (e) => navigateTo(e.currentTarget.dataset.target)));
                document.getElementById('dark-mode-toggle').addEventListener('click', toggleTheme);
                document.getElementById('settings-button-header').addEventListener('click', () => navigateTo('settings-section'));
                backButton.addEventListener('click', () => window.history.back());
            }

            async function fetchApi(endpoint, options = {}) {
                const userInfo = getUserInfo();
                const headers = { ...options.headers };
                if (userInfo?.token) headers['Authorization'] = `Bearer ${userInfo.token}`;
                if (!(options.body instanceof FormData)) headers['Content-Type'] = 'application/json';
                try {
                    const response = await fetch(`${API_BASE_URL}/api${endpoint}`, { ...options, headers });
                    if (response.status === 401) { logout(); return null; }
                    return response;
                } catch (error) { console.error("API Error:", error); return null; }
            }

            async function fetchProductData(barcode) {
                if (!barcode?.trim()) { showToast('Invalid barcode', 'error'); return; }
                loadingOverlay.classList.add('active');
                const response = await fetchApi(`/products/${barcode}`);
                loadingOverlay.classList.remove('active');
                if (!response) return; 
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('product-section').innerHTML = createProductDetailHTML(data);
                    navigateTo('product-section');
                    currentBarcode = barcode;
                    const userInfo = getUserInfo();
                    if (userInfo?.token) fetchApi('/scans', { method: 'POST', body: JSON.stringify({ barcode: data.barcode, product: data }) });
                } else {
                    if (response.status === 404) {
                        currentBarcode = barcode;
                        showToast("Product not found.", 'info');
                        showAddProductForm();
                    } else showToast("Error fetching product", 'error');
                }
            }

            function startScanner() {
                if (!html5QrCode) html5QrCode = new Html5Qrcode("scanner-viewport");
                const startBtn = document.getElementById('start-scan-btn');
                const laser = document.getElementById('scanner-laser');
                if (startBtn) startBtn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Starting...`;
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                const onScanSuccess = (decodedText) => {
                    if (laser) laser.style.display = 'none';
                    if (navigator.vibrate) navigator.vibrate(50);
                    if (scannerStartPromise) {
                        scannerStartPromise.then(() => {
                            if (html5QrCode.isScanning) {
                                html5QrCode.stop().then(() => {
                                    html5QrCode.clear();
                                    fetchProductData(decodedText);
                                });
                            }
                        });
                    }
                };
                scannerStartPromise = html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                    .then(() => {
                        if (startBtn) startBtn.classList.add('hidden');
                        if (laser) laser.style.display = 'block';
                    })
                    .catch((err) => {
                        return html5QrCode.start({ facingMode: "user" }, config, onScanSuccess)
                            .then(() => {
                                if (startBtn) startBtn.classList.add('hidden');
                                if (laser) laser.style.display = 'block';
                            });
                    })
                    .catch((err) => {
                        alert(`Camera Error: ${err}`);
                        if (startBtn) {
                            startBtn.innerHTML = `<i class="fas fa-camera"></i> Retry Camera`;
                            startBtn.classList.remove('hidden'); 
                        }
                    });
            }

            function stopScanner() {
                const laser = document.getElementById('scanner-laser');
                if (laser) laser.style.display = 'none';
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        html5QrCode.clear();
                        const startBtn = document.getElementById('start-scan-btn');
                        if (startBtn) {
                            startBtn.innerHTML = `<i class="fas fa-camera text-primary"></i> Tap to Scan`;
                            startBtn.classList.remove('hidden');
                        }
                    }).catch(e => console.log(e));
                }
            }

            async function renderScanner() {
                const scannerSection = document.getElementById('scanner-section');
                if (!getUserInfo()) { scannerSection.innerHTML = createLoginPromptHTML(); return; }
                scannerSection.innerHTML = createScannerHTML([]);
                document.getElementById('start-scan-btn').addEventListener('click', startScanner);
                document.getElementById('manual-entry-btn').addEventListener('click', showManualEntryModal);
                const response = await fetchApi('/products/trending');
                if (response?.ok) {
                    const trending = await response.json();
                    const trendingContainer = document.getElementById('trending-container');
                    if (trendingContainer) trendingContainer.innerHTML = createTrendingListHTML(trending);
                    document.querySelectorAll('.trending-item').forEach(item => {
                        item.addEventListener('click', () => fetchProductData(item.dataset.barcode));
                    });
                }
            }

            function renderSettings() {
                const user = getUserInfo();
                const createSettingItem = (icon, title, subtitle = '', action = '') => `
                    <div class="flex items-center gap-4 p-4 border-b border-gray-100 dark:border-gray-700 last:border-0 cursor-pointer active:bg-gray-50 dark:active:bg-gray-700 transition" ${action ? `onclick="${action}"` : ''}>
                        <div class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-500 dark:text-gray-400"><i class="${icon}"></i></div>
                        <div class="flex-1"><h4 class="font-medium text-sm text-gray-900 dark:text-gray-100">${title}</h4>${subtitle ? `<p class="text-xs text-gray-500">${subtitle}</p>` : ''}</div>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                    </div>`;
                const notifState = localStorage.getItem('notifications') === 'off' ? 'Off' : 'On';
                window.toggleNotif = () => {
                    const current = localStorage.getItem('notifications');
                    localStorage.setItem('notifications', current === 'off' ? 'on' : 'off');
                    renderSettings();
                    showToast(`Notifications turned ${current === 'off' ? 'On' : 'Off'}`);
                };

                document.getElementById('settings-section').innerHTML = `
                <div class="space-y-6 fade-in pb-10">
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-3xl shadow-card">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-primary to-emerald-600 flex items-center justify-center text-white text-2xl font-bold shadow-lg">
                                ${user ? user.name[0].toUpperCase() : '<i class="fas fa-user"></i>'}
                            </div>
                            <div><h3 class="font-bold text-lg dark:text-white leading-tight">${user ? user.name : 'Guest User'}</h3><p class="text-xs text-gray-500">${user ? user.email : 'Sign in to sync'}</p></div>
                        </div>
                        ${user ? `<button id="logout-btn" class="w-full py-3 rounded-xl bg-red-50 text-red-500 font-semibold text-sm border border-red-100 dark:bg-red-900/10 dark:border-red-900/30">Log Out</button>` : `<button id="login-nav-btn" class="w-full py-3 rounded-xl bg-primary text-white font-bold text-sm shadow-lg shadow-primary/30">Login / Register</button>`}
                    </div>
                    <div><h3 class="px-2 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">General</h3><div class="bg-white dark:bg-gray-800 rounded-3xl shadow-card overflow-hidden">
                        ${createSettingItem('fas fa-download', 'Install App', 'Add to Home Screen', "installApp()")}
                        ${createSettingItem('fas fa-bell', 'Notifications', notifState, "toggleNotif()")}
                        ${createSettingItem('fas fa-globe', 'Language', 'English', "showToast('Only English is currently supported')")}
                        ${createSettingItem('fas fa-moon', 'Dark Mode', 'Toggle theme', "toggleTheme()")}
                    </div></div>
                    <div><h3 class="px-2 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Support & Legal</h3><div class="bg-white dark:bg-gray-800 rounded-3xl shadow-card overflow-hidden">
                        ${createSettingItem('fas fa-shield-alt', 'Privacy Policy', '', "showPolicyModal()")}
                        ${createSettingItem('fas fa-file-contract', 'Terms of Service', '', "showTermsModal()")}
                        ${createSettingItem('fas fa-headset', 'Help & Support', 'Email us', "window.location.href='mailto:prajwaldhande017@gmail.com?subject=Support Request - Tattvam App'")}
                        ${createSettingItem('fas fa-info-circle', 'About Tattvam', 'v2.0.0', "")}
                    </div></div>
                    <div class="text-center text-xs text-gray-400 py-4"><p>Tattvam App v2.0.0 (Beta)</p><p class="mt-1">Made with <i class="fas fa-heart text-red-400"></i> in India</p></div>
                </div>`;
                
                if (user) document.getElementById('logout-btn').addEventListener('click', logout);
                else document.getElementById('login-nav-btn').addEventListener('click', showLoginModal);
            }

            const createScannerHTML = (trending) => `
                <div class="space-y-6 fade-in pb-6">
                    <div class="relative w-full h-80 rounded-3xl overflow-hidden bg-black shadow-lg border-2 border-gray-800/50">
                        <div id="scanner-viewport" class="w-full h-full"></div>
                        <div id="scanner-laser" class="scanner-laser"></div>
                        <div class="absolute bottom-6 left-0 right-0 text-center pointer-events-none">
                            <span class="inline-block bg-black/60 backdrop-blur-md text-white/90 text-xs font-semibold px-4 py-2 rounded-full border border-white/10 shadow-lg">Align barcode within frame</span>
                        </div>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <button id="start-scan-btn" class="pointer-events-auto bg-white dark:bg-gray-800 text-gray-900 dark:text-white font-bold py-3.5 px-8 rounded-full shadow-2xl flex items-center gap-2 transform active:scale-95 transition hover:shadow-glow border border-gray-100 dark:border-gray-700">
                                <i class="fas fa-camera text-primary text-lg"></i> <span class="text-sm">Tap to Scan</span>
                            </button>
                        </div>
                    </div>
                    <button id="manual-entry-btn" class="w-full glass-effect py-4 rounded-2xl flex items-center justify-center gap-3 font-semibold text-primaryDark dark:text-primary transition active:scale-[0.98] shadow-sm">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center"><i class="fas fa-keyboard text-primary"></i></div> Enter Barcode Manually
                    </button>
                    <div>
                        <div class="flex items-center justify-between mb-4 px-1">
                            <h3 class="font-bold text-lg text-gray-800 dark:text-gray-100">Trending Now</h3>
                            <span class="text-xs font-bold text-primary bg-primary/10 px-2 py-1 rounded-lg">India</span>
                        </div>
                        <div id="trending-container" class="flex overflow-x-auto gap-4 pb-4 -mx-4 px-4 scrollbar-hide">
                            <div class="w-full text-center py-4 text-gray-400 text-sm">Loading trends...</div>
                        </div>
                    </div>
                </div>`;

            const createTrendingListHTML = (products) => {
                if (!products || products.length === 0) return `<p class="text-gray-500 text-sm pl-2">No trending products yet.</p>`;
                return products.map(p => {
                    const imgSrc = buildImageUrl(p.imageUrl || p.image_url || p.productImage);
                    const name = p.name || "Product";
                    const brand = p.brand || "Brand";
                    const rating = Math.max(0, Math.min(5, Number(p.rating) || 0));
                    return `
                    <div class="trending-item flex-shrink-0 w-36 glass-effect p-3 rounded-2xl shadow-card cursor-pointer border border-transparent hover:border-primary/30 transition bg-white dark:bg-gray-800" data-barcode="${p.barcode}">
                        <div class="w-full h-24 mb-3 bg-white dark:bg-gray-700/50 rounded-xl p-2 flex items-center justify-center"><img src="${imgSrc}" class="max-w-full max-h-full object-contain"></div>
                        <p class="font-bold text-sm truncate text-gray-800 dark:text-gray-200">${name}</p>
                        <p class="text-[10px] text-gray-500 truncate mb-1">${brand}</p>
                        <div class="text-[10px] text-yellow-400">${generateStarRating(rating)}</div>
                    </div>`;
                }).join('');
            }

            const createProductDetailHTML = (p) => {
                const imgSrc = buildImageUrl(p.imageUrl || p.image_url || p.productImage);
                const name = p.name || p.product_name || "Unknown";
                const brand = p.brand || p.product_brand || "Unknown Brand";
                const nut = p.nutrition || {};
                const score = p.nutriScore || "E";
                const rating = Math.max(0, Math.min(5, Number(p.rating) || 0));
                const scoreColor = { A: "bg-green-500", B: "bg-lime-500", C: "bg-yellow-500", D: "bg-orange-500", E: "bg-red-500" }[score] || "bg-gray-400";
                
                const getIngColor = (txt) => {
                    const lower = txt.toLowerCase();
                    const bad = ['sugar', 'syrup', 'oil', 'fat', 'salt', 'preservative', 'e1', 'e2', 'e3', 'e4', 'e5', 'e6', 'artificial', 'flavor', 'flavour', 'color'];
                    const isBad = bad.some(b => lower.includes(b));
                    return isBad ? 'bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-300 border-red-100 dark:border-red-800' : 'bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 border-green-100 dark:border-green-800';
                };

                let ingHTML = "";
                if(Array.isArray(p.ingredients) && p.ingredients.length) ingHTML = p.ingredients.map(i => `<span class="py-1.5 px-3 rounded-lg text-xs font-semibold border ${getIngColor(i.name)}">${i.name}</span>`).join('');
                else if(typeof p.ingredients === "string") ingHTML = p.ingredients.split(',').map(s => `<span class="py-1.5 px-3 rounded-lg text-xs font-semibold border ${getIngColor(s.trim())}">${s.trim()}</span>`).join('');

                return `
                <div class="space-y-5 pb-6 fade-in">
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-3xl shadow-card border border-gray-100 dark:border-gray-700">
                        <div class="flex gap-4">
                            <div class="w-24 h-24 bg-gray-50 dark:bg-gray-700 rounded-2xl p-2 flex items-center justify-center flex-shrink-0"><img src="${imgSrc}" class="max-w-full max-h-full object-contain"></div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs font-bold text-primary tracking-wide uppercase mb-0.5">${brand}</p>
                                <h2 class="text-xl font-bold leading-tight truncate mb-1 text-gray-900 dark:text-white">${name}</h2>
                                <div class="flex items-center gap-2 mb-2"><div class="text-yellow-400 text-xs">${generateStarRating(rating)}</div><span class="text-xs font-bold text-gray-500 pt-0.5">${rating.toFixed(1)}</span></div>
                                <div class="flex items-center gap-2"><div class="w-10 h-10 rounded-lg ${scoreColor} flex items-center justify-center text-white font-bold shadow-sm">${score}</div><div class="text-xs text-gray-500 dark:text-gray-400 leading-tight">Nutri-Score<br>Grade</div></div>
                            </div>
                        </div>
                    </div>
                    ${p.warnings?.length ? `<div class="bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-800/30 p-4 rounded-2xl"><div class="flex items-center gap-2 mb-2"><i class="fas fa-exclamation-circle text-red-500"></i><h3 class="font-bold text-red-700 dark:text-red-400 text-sm">Attention Needed</h3></div><ul class="text-xs text-red-600 dark:text-red-300 space-y-1 list-disc pl-4 opacity-90">${p.warnings.map(w=>`<li>${w}</li>`).join('')}</ul></div>` : ''}
                    <div class="grid grid-cols-4 gap-2">
                        <div class="bg-white dark:bg-gray-800 p-3 rounded-2xl text-center shadow-sm border border-gray-100 dark:border-gray-700"><div class="text-lg font-bold text-gray-800 dark:text-white">${nut.calories||0}</div><div class="text-[10px] text-gray-500 font-medium">Kcal</div></div>
                        <div class="bg-white dark:bg-gray-800 p-3 rounded-2xl text-center shadow-sm border border-gray-100 dark:border-gray-700"><div class="text-lg font-bold text-blue-500">${nut.protein||0}g</div><div class="text-[10px] text-gray-500 font-medium">Prot</div></div>
                        <div class="bg-white dark:bg-gray-800 p-3 rounded-2xl text-center shadow-sm border border-gray-100 dark:border-gray-700"><div class="text-lg font-bold text-orange-500">${nut.carbs||0}g</div><div class="text-[10px] text-gray-500 font-medium">Carb</div></div>
                        <div class="bg-white dark:bg-gray-800 p-3 rounded-2xl text-center shadow-sm border border-gray-100 dark:border-gray-700"><div class="text-lg font-bold text-yellow-500">${nut.fat||0}g</div><div class="text-[10px] text-gray-500 font-medium">Fat</div></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-3xl shadow-card border border-gray-100 dark:border-gray-700"><h3 class="font-bold text-gray-900 dark:text-white mb-3">Ingredients</h3><div class="flex flex-wrap gap-2">${ingHTML || '<p class="text-sm text-gray-400">No data.</p>'}</div></div>
                </div>`;
            }

            async function renderHistory() {
                const section = document.getElementById('history-section');
                if (!getUserInfo()) { section.innerHTML = createLoginPromptHTML(); return; }
                section.innerHTML = `<div class="space-y-3 p-2"><div class="animate-pulse h-20 bg-gray-200 dark:bg-gray-700 rounded-2xl"></div><div class="animate-pulse h-20 bg-gray-200 dark:bg-gray-700 rounded-2xl"></div></div>`;
                const response = await fetchApi('/scans/my');
                if (response?.ok) {
                    const data = await response.json();
                    if (!data.length) { section.innerHTML = createEmptyStateHTML("No scan history yet."); return; }
                    section.innerHTML = `<div class="space-y-3 pb-6">${data.map(p => {
                        const imgSrc = buildImageUrl(p.image_url || p.productImage);
                        const name = p.productName || p.name || "Unknown";
                        const date = new Date(p.createdAt).toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                        const rating = Math.max(0, Math.min(5, Number(p.rating) || 0));
                        return `<div class="bg-white dark:bg-gray-800 p-3 rounded-2xl shadow-sm flex items-center gap-3 cursor-pointer active:scale-[0.99] transition border border-gray-100 dark:border-gray-700" onclick="fetchProductData('${p.barcode}')"><img src="${imgSrc}" class="w-14 h-14 rounded-xl object-contain bg-gray-50 dark:bg-gray-700 p-1"><div class="flex-1 min-w-0"><h4 class="font-bold text-sm truncate dark:text-white">${name}</h4><div class="flex items-center gap-2 mt-0.5"><div class="text-[10px] text-yellow-400 flex">${generateStarRating(rating)}</div><p class="text-xs text-gray-500">â€¢ ${date}</p></div></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div>`;
                    }).join('')}</div>`;
                    window.fetchProductData = fetchProductData; 
                } else section.innerHTML = createEmptyStateHTML("Failed to load history.");
            }

            function renderExplore() { document.getElementById('explore-section').innerHTML = createComingSoonHTML("Explore"); }
            function renderProgress() { document.getElementById('progress-section').innerHTML = createComingSoonHTML("Progress"); }

            function getUserInfo() { try { return JSON.parse(localStorage.getItem('userInfo')); } catch { return null; } }
            function logout() { localStorage.removeItem('userInfo'); showToast("Logged out"); navigateTo('scanner-section'); }
            function showToast(msg, type='info') {
                const t = document.createElement('div');
                const colors = { error: 'bg-red-500', success: 'bg-green-500', info: 'bg-gray-800' };
                t.className = `${colors[type]} text-white px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3 text-sm font-medium animate-bounce`;
                t.innerHTML = `<i class="fas ${type==='error'?'fa-exclamation-circle':'fa-info-circle'}"></i> ${msg}`;
                const c = document.getElementById('toast-container');
                c.appendChild(t);
                setTimeout(() => t.remove(), 3000);
            }
            function showModal(html) {
                modalContainer.innerHTML = html;
                modalContainer.classList.remove('hidden');
                modalContainer.classList.add('flex');
                setTimeout(() => modalContainer.classList.remove('opacity-0'), 10);
            }
            function closeModal() {
                modalContainer.classList.add('opacity-0');
                setTimeout(() => { modalContainer.classList.add('hidden'); modalContainer.classList.remove('flex'); }, 300);
            }
            function buildImageUrl(path) { 
                if (!path || typeof path !== 'string') return 'https://placehold.co/150?text=No+Img';
                if (path.startsWith('http')) return path;
                return `${API_BASE_URL}${path.startsWith('/') ? '' : '/'}${path}`; 
            }
            function generateStarRating(r) {
                let h = '';
                for(let i=1; i<=5; i++) h += i<=r ? '<i class="fas fa-star"></i>' : (i-0.5<=r ? '<i class="fas fa-star-half-alt"></i>' : '<i class="far fa-star"></i>');
                return h;
            }

            const createLoginPromptHTML = () => `<div class="flex flex-col items-center justify-center h-64 text-center px-6"><div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4"><i class="fas fa-lock text-2xl text-gray-400"></i></div><h3 class="font-bold text-lg mb-1 dark:text-white">Login Required</h3><p class="text-sm text-gray-500 mb-6">Please log in to use the scanner.</p><button onclick="navigateTo('settings-section')" class="bg-primary text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-primary/30">Go to Login</button></div>`;
            const createEmptyStateHTML = (msg) => `<div class="flex flex-col items-center justify-center h-64 text-center text-gray-400"><i class="fas fa-box-open text-4xl mb-3 opacity-50"></i><p>${msg}</p></div>`;
            const createComingSoonHTML = (t) => `<div class="flex flex-col items-center justify-center h-64 text-center text-gray-400"><i class="fas fa-tools text-4xl mb-3 opacity-50"></i><p>${t} coming soon</p></div>`;
            
            window.showLoginModal = () => {
                showModal(`<div class="bg-white dark:bg-gray-800 w-full max-w-sm p-6 rounded-3xl shadow-2xl relative"><button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button><h2 class="text-2xl font-bold mb-6 text-center dark:text-white">Welcome Back</h2><form id="login-form" class="space-y-4"><input name="email" type="email" placeholder="Email" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-gray-700 border-none outline-none focus:ring-2 ring-primary/50" required><input name="password" type="password" placeholder="Password" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-gray-700 border-none outline-none focus:ring-2 ring-primary/50" required><button type="submit" class="w-full bg-primary text-white font-bold py-4 rounded-xl shadow-lg shadow-primary/30">Log In</button></form><p class="text-center mt-6 text-sm text-gray-500">No account? <button onclick="showRegisterModal()" class="text-primary font-bold">Register</button></p></div>`);
                document.getElementById('login-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const res = await fetchApi('/users/login', { method: 'POST', body: JSON.stringify(Object.fromEntries(new FormData(e.target))) });
                    if (res?.ok) { localStorage.setItem('userInfo', JSON.stringify(await res.json())); closeModal(); showToast("Logged In", "success"); navigateTo('scanner-section'); }
                    else showToast("Login failed", "error");
                });
            }
            
            window.showRegisterModal = () => {
                showModal(`<div class="bg-white dark:bg-gray-800 w-full max-w-sm p-6 rounded-3xl shadow-2xl relative"><button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button><h2 class="text-2xl font-bold mb-6 text-center dark:text-white">Join Tattvam</h2><form id="reg-form" class="space-y-4"><input name="name" type="text" placeholder="Full Name" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-gray-700 border-none outline-none focus:ring-2 ring-primary/50" required><input name="email" type="email" placeholder="Email" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-gray-700 border-none outline-none focus:ring-2 ring-primary/50" required><input name="password" type="password" placeholder="Password" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-gray-700 border-none outline-none focus:ring-2 ring-primary/50" required><button type="submit" class="w-full bg-primary text-white font-bold py-4 rounded-xl shadow-lg shadow-primary/30">Create Account</button></form><p class="text-center mt-6 text-sm text-gray-500">Have account? <button onclick="showLoginModal()" class="text-primary font-bold">Log In</button></p></div>`);
                document.getElementById('reg-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const res = await fetchApi('/users/register', { method: 'POST', body: JSON.stringify(Object.fromEntries(new FormData(e.target))) });
                    if (res?.ok) { localStorage.setItem('userInfo', JSON.stringify(await res.json())); closeModal(); showToast("Welcome!", "success"); navigateTo('scanner-section'); }
                    else showToast("Failed to register", "error");
                });
            }

            window.showManualEntryModal = () => {
                showModal(`<div class="bg-white dark:bg-gray-800 w-full max-w-sm p-6 rounded-3xl shadow-2xl"><h3 class="font-bold text-xl mb-4 dark:text-white">Manual Entry</h3><form id="manual-form"><input id="b-in" type="number" placeholder="Barcode Number" class="w-full p-4 rounded-xl bg-gray-100 dark:bg-gray-700 mb-4 outline-none" required><div class="flex gap-3"><button type="button" onclick="closeModal()" class="flex-1 py-3 bg-gray-200 dark:bg-gray-600 rounded-xl font-semibold">Cancel</button><button type="submit" class="flex-1 py-3 bg-primary text-white rounded-xl font-semibold">Search</button></div></form></div>`);
                document.getElementById('manual-form').addEventListener('submit', (e) => { e.preventDefault(); closeModal(); fetchProductData(document.getElementById('b-in').value); });
            }

            window.showAddProductForm = () => {
                showModal(`<div class="bg-white dark:bg-gray-800 w-full max-w-sm p-6 rounded-3xl shadow-2xl"><h3 class="font-bold text-xl mb-2 dark:text-white">Add Product</h3><p class="text-xs text-gray-500 mb-4">Barcode: ${currentBarcode}</p><form id="add-form" class="space-y-3"><input name="name" placeholder="Name" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-xl" required><input name="brand" placeholder="Brand" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-xl" required><input name="image" type="file" class="w-full text-sm" required><div class="flex gap-3 mt-2"><button type="button" onclick="closeModal()" class="flex-1 py-3 bg-gray-200 dark:bg-gray-600 rounded-xl font-semibold">Cancel</button><button type="submit" class="flex-1 py-3 bg-primary text-white rounded-xl font-semibold">Submit</button></div></form></div>`);
                document.getElementById('add-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target); fd.append('barcode', currentBarcode);
                    const res = await fetchApi('/products', { method: 'POST', body: fd });
                    if(res?.ok) { showToast("Submitted!"); closeModal(); } else showToast("Failed", "error");
                });
            }

            // Legal Modals
            window.showPolicyModal = () => showModal(`<div class="bg-white dark:bg-gray-800 w-full max-w-md p-6 rounded-3xl shadow-2xl h-[70vh] overflow-y-auto"><h2 class="text-xl font-bold mb-4 dark:text-white">Privacy Policy</h2><p class="text-sm text-gray-500 mb-4">We collect minimal data to improve scanning accuracy. Your scan history is stored securely.</p><button onclick="closeModal()" class="w-full py-2 bg-primary text-white rounded-lg font-bold">Close</button></div>`);
            window.showTermsModal = () => showModal(`<div class="bg-white dark:bg-gray-800 w-full max-w-md p-6 rounded-3xl shadow-2xl h-[70vh] overflow-y-auto"><h2 class="text-xl font-bold mb-4 dark:text-white">Terms of Service</h2><p class="text-sm text-gray-500 mb-4">By using Tattvam, you agree to our terms. Information is for reference only.</p><button onclick="closeModal()" class="w-full py-2 bg-primary text-white rounded-lg font-bold">Close</button></div>`);

            function initializeTheme() {
                const isDark = localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
                document.documentElement.classList.toggle('dark', isDark);
            }
            window.toggleTheme = () => {
                document.documentElement.classList.toggle('dark');
                localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            }

            window.closeModal = closeModal;
            window.navigateTo = navigateTo;
            initializeApp();
        });
    </script>
</body>
</html>